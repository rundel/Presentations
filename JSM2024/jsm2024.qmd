---
title: "Programmatic Manipulation of<br/>Quarto Documents for Teaching"
subtitle: "JSM 2024 - Portland"
author: "Colin Rundel"
institute: "Duke University"
footer: ""
format:
  revealjs:
    theme: slides.scss
    transition: fade
    slide-number: true
    self-contained: true
title-slide-attributes:
  data-background-image: background.png
  data-background-size: cover
execute:
  echo: true
---


```{r setup}
#| include: false
options(width=80)
library(fontawesome)
library(parsermd)
```

## `parsermd`

implements a C++ parser and abstract syntax tree (AST) for Quarto and R Markdown documents in R.

* supports manipulating of the ASTs (filtering, editing, etc.)

* ability to directly source and render the ASTs

* Started life during covid to aide in the grading of student assignments in a large machine learning course 

* v0.1.3 is on CRAN, v0.2.0 with full Quarto support on GitHub (CRAN imminently)



## Quarto elements

::: {.code-file .sourceCode .cell-code}
&nbsp;`r fontawesome::fa("file")` `hello.qmd`
:::

````{.markdown code-line-numbers="|1-4|14,19,47,49,56|6-12|6|7,8|10,11|51-54|60-73|79"}
{{< include _hello.qmd >}}
````


## Elements as AST

```{r}
qmd = parse_qmd("hello.qmd")
```

:::: {.columns}
::: {.column width='50%'}
```{r}
qmd |> print(flat = TRUE)
```
:::

::: {.column width='50%' .fragment}
```{r}
qmd |> print()
```
:::
::::

## As a tibble

```{r}
parse_qmd("hello.qmd") |> as_tibble()
```


## Why hierarchy?

Use a CSS selector like approach to target specific nodes based on *headings*,


:::: {.columns}
::: {.column width='50%'}
```{r}
qmd |> rmd_select(by_section("Meet Quarto"))
```
:::

::: {.column width='50%' .fragment}
```{r}
qmd |> rmd_select(by_section("Fenced divs"))
```
:::
::::

. . .

```{r}
qmd |> rmd_select(by_section(c("Other Quarto features", "*code*")))
```

```{r}
qmd |> rmd_select(by_section(c("Other Quarto features", "*code*"), keep_parents = FALSE))
```


## ast to quarto

These ASTs can be converted back to Quarto documents at any point,

:::: {.columns}
::: {.column width='50%'}
```{r}
qmd |> 
  rmd_select(by_section("Meet Quarto")) |>
  as_document() |>
  cat(sep = "\n")
```
:::

::: {.column width='50%' .fragment}
```{r}
qmd |> 
  rmd_select(by_section("Fenced divs")) |>
  as_document() |>
  cat(sep = "\n")
```
:::
::::

. . .

```{r}
qmd |> 
  rmd_select(by_section(c("Other Quarto features", "*code blocks*"), keep_parents = FALSE)) |>
  as_document() |>
  cat(sep = "\n")
```


## Additional selectors

While a work in progress, we are adding additional helpers based on `tidyselect`,

:::: {.columns}
::: {.column width='50%'}
```{r}
qmd |> rmd_select("plot-penguins")
```
:::

::: {.column width='50%'}
```{r}
qmd |> rmd_select(has_label("*p*"))
```
:::
::::

. . .

```{r}
qmd |> rmd_select(has_type(c("rmd_yaml", "rmd_chunk")))
```

. . .

```{r}
qmd |> rmd_select(!has_type("rmd_markdown"))
```

## Rendering

ASTs can also be directly rendered 

```{r}
#| results: hide
qmd |> render("hello_quarto")
```


<iframe src="hello_quarto.html" width="1000px" height="500px" style="padding: 5px;border: 1px solid darkgrey;">
</iframe>


# In Practice

## Spring 2024 - hw1

```{r}
fs::dir_tree("repos/")
```
::: {.aside}
These folders are the, lightly modified, result of cloning student repos using [`ghclass`](https://rundel.github.io/ghclass/).
:::


## Homework structure

::: {.panel-tabset}

### ast

```{r}
(hw1 = parse_qmd("repos/hw01_team01/hw1.qmd"))
```

### html

<iframe src="hw1.html" width="1000px" height="500px" style="padding: 5px;">
</iframe>

:::


## Simplifying the document

```{r}
hw1 |>
  rmd_select(by_section(c("Task 1 - Implement fizzbuzz")))
```

. . .

```{r}
hw1 |>
  rmd_select(by_section(c("Task 1 - Implement fizzbuzz"))) |>
  rmd_select(!by_section("Testing"))
```


## Adding something more

```{r}
hw1 |>
  rmd_select(by_section(c("Task 1 - Implement fizzbuzz"))) |>
  rmd_select(!by_section("Testing")) |>
  rmd_ast_append(
    rmd_chunk(name = "tests", code = c(
      "fizzbuzz(1:5)",
      "fizzbuzz(5:1)",
      "fizzbuzz(-1)"
    ), options = list(error = TRUE))
  )
```

## Rendering the result

::: {.panel-tabset}
### Code

```{r}
#| echo: false
setwd("single/")
```

```{r}
hw1 |>
  rmd_select(by_section(c("Task 1 - Implement fizzbuzz"))) |>
  rmd_select(!by_section("Testing")) |>
  rmd_ast_append(
    rmd_chunk(name = "tests", code = c(
      "fizzbuzz(1:5)",
      "fizzbuzz(5:1)",
      "fizzbuzz(-1)"
    ), options = list(error = TRUE))
  ) |>
  render("hw1_task1")
```

```{r}
#| echo: false
setwd("../")
```

### html

<iframe src="single/hw1_task1.html" width="1000px" height="500px" style="padding: 5px;">
</iframe>

:::



## Document collections

> "Of course someone has to write for loops. It doesnâ€™t have to be you." - Jenny Bryan

```{r}
(hw1 = parse_qmd_collection("repos/"))
```

. . .

```{r}
hw1 |> as_ast()
```

## Filtering

```{r}
(task1 = hw1 |> rmd_select(by_section(c("Task 1 - Implement fizzbuzz", "Write up"))))
```

. . .

```{r}
task1 |> as_ast()
```

## Rendering

::: {.panel-tabset}
### Code

```{r}
task1 |> render(name = "hw1_task1")
```

### Output

<iframe src="hw1_task1.html" width="1000px" height="500px" style="padding: 5px;">
</iframe>
:::

## Code chunks + rendering

::: {.panel-tabset}
### Code

```{r}
(fb = hw1 |> 
  rmd_select("fizzbuzz") |> 
  rmd_ast_append(
    rmd_chunk(name = "tests", code = c(
      "fizzbuzz(1:5)",
      "fizzbuzz(5:1)",
      "fizzbuzz(-1)"
    ), options = list(error = TRUE))
  ) |>
  as_ast() |>
  rmd_ast_prepend(
    rmd_chunk(code = "library(tidyverse)", options = list(include=FALSE))
  )
)
```

### Output

```{r}
#| result: "hide"
fb |> render("hw1_task1_code")
```

<iframe src="hw1_task1_code.html" width="1000px" height="500px" style="padding: 5px;">
</iframe>
